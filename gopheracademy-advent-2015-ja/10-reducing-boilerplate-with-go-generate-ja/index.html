<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>12月10日 - Reducing boilerplate with go generate &middot; tbd</title>
  <meta name="description" content="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法">
  <meta name="format-detection" content="telephone=no">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="daikikohara" />
  <meta name="twitter:title" content="12月10日 - Reducing boilerplate with go generate &middot; tbd">
  <meta name="twitter:description" content="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法">

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="12月10日 - Reducing boilerplate with go generate &middot; tbd">
  <meta property="og:description" content="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法">

  <link rel="icon" href="http://localhost:1313/favicon.ico" >
  <link rel="shortcut icon" href="http://localhost:1313/favicon.ico" >
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:1313//css/pure-min.css">
  
  
    <link rel="stylesheet" href="http://localhost:1313//css/grids-responsive-min.css">
  
  <link rel="stylesheet" href="http://localhost:1313//css/all.min.css">
</head>
<body>


<div id="container">
  <header class="header">
  <div class="header-content pure-g">
    <div class="header-content-left pure-u-1 pure-u-md-1-2">
      <a class="site-title" href="http://localhost:1313/">tbd</a>
      <span class="site-description"></span>
    </div>
    <div class="header-content-right pure-u-1 pure-u-md-1-2">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="http://localhost:1313/about">About</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/blog">Blog</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/work">Work</a>
        </li>
      </ul>
    </div>
  </div>
</header>

  <div class="main">
    <div class="meta">
      <time class="time">31 Dec 2015, 15:09</time>
      <span class="category">
        
          categories:
          
          <a class="category-name category-name-golang" href="http://localhost:1313//categories/golang">golang</a>
        
      </span>
    </div>
    <section class="post">
      <header>
        <div class="title-single">12月10日 - Reducing boilerplate with go generate</div>
        <div class="author">
          
          
            元記事の著者 - <strong class="author-name">Ernesto Jiménez</strong>
          
        </div>
      </header>
      <div class="description">
        

<div class='note'>※本ポストは<a href="https://blog.gopheracademy.com/">Gopher Academy</a>の<a href="https://blog.gopheracademy.com/series/advent-2015/">Advent 2015</a>の<a href="https://blog.gopheracademy.com/advent-2015/reducing-boilerplate-with-go-generate/">12月10日の記事</a>の日本語訳です。</div>

<p>Goは素晴らしい言語だ。シンプルでパワフルな素晴らしいツールがあり、多くの人が日々本当にGoを楽しんでいる。
しかし型付けされた言語でよくあるようにたくさんのboilerplateを書かなければならない。</p>

<p>このポストでは主に以下の3つの点をカバーする。</p>

<ol>
<li>なぜコード生成を使ってboilerplateを削減するようなツールをGoで書くことができるのか</li>
<li>Goでのコード生成は何で構成されているか</li>
<li>より詳しく知りたい場合にコード生成ツールの例がどこにあるか</li>
</ol>

<h2 id="なぜboilerplateを削減するためにコード生成を使うのか:e2f2be23ee9108c94286c14975225274">なぜboilerplateを削減するためにコード生成を使うのか</h2>

<p>boilerplateを削減するためにリフレクションを使ったり、<code>interface{}</code>を受け取るメソッドだらけにしたりしてしまうことがある。
しかし、メソッドが<code>interface{}</code>を受け取る際は型安全性を捨ててしまっている。
型のアサーションとリフレクションを使う場合、正しい型を渡しているかのチェックをコンパイラができなくなり実行時にpanicが発生しやすくなってしまう。</p>

<p>いくつかのboilerplateコードはプロジェクト内の既存のコードから推測できる場合が多い。
よって、プロジェクトのソースコードを読み、関連するコードを生成するツールを作ることができる。</p>

<h2 id="コード生成の構成要素:e2f2be23ee9108c94286c14975225274">コード生成の構成要素</h2>

<h3 id="コードの読み込み:e2f2be23ee9108c94286c14975225274">コードの読み込み</h3>

<p>標準ライブラリにはコードを読んでパースする際に手間のかかる作業を行ってくれる素晴らしいパッケージが揃っている。</p>

<ul>
<li><code>go/build</code>: goのパッケージの情報を集める。パッケージ名が与えられるとパッケージのソースディレクトリやその中のソースファイル・テストファイル、及び依存している他のパッケージ等の情報を返す。</li>
<li><code>go/scanner</code>及び<code>go/parser</code>: ソースコードを読んでパースし、<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>を生成する。</li>
<li><code>go/ast</code>: ASTを表現する型を宣言し、木を探索・修正するためのメソッドを含む。</li>
<li><code>go/types</code>: データ型を宣言しGoのパッケージの型チェックに使われるアルゴリズムを実装する。<code>go/ast</code>が木をそのまま保持するのに対して、このパッケージはASTを処理する全てのタスクを行うため、型の情報を直接取得することができる。</li>
</ul>

<h3 id="コードの生成:e2f2be23ee9108c94286c14975225274">コードの生成</h3>

<p>コードを生成する際、殆どのプロジェクトは旧来の<code>text/template</code>を使って生成するだろう。</p>

<p>生成されたファイルにはコードが自動生成されたこと、どのツールが生成したか、手動で編集すべきでないことを示すコメントを書くことを推奨する。</p>

<pre><code>/*
* CODE GENERATED AUTOMATICALLY WITH github.com/ernesto-jimenez/gogen/unmarshalmap
* THIS FILE SHOULD NOT BE EDITED BY HAND
*/
</code></pre>

<p><code>go/format</code>パッケージを使って書き込む前に整形することも可能だ。このパッケージは<code>go fmt</code>で使われているロジックを含むものである。</p>

<h3 id="go-generate:e2f2be23ee9108c94286c14975225274">go generate</h3>

<p>コードを生成するツールを書き始めると、次の2つの疑問が浮かぶだろう。
開発プロセスのどの時点でコードを生成するのか。生成されたコードをどのように最新に保つのか。</p>

<p>1.4以降ではgoツールは<code>generate</code>をコマンドを含んでいる。
これを使うとgoツール自身と同時にコード生成用のツールを実行することができる。
ソースコード内の特定のコメントを使ってどのコマンドを実行するかを指定でき、<code>go generate</code>が実行してくれる。</p>

<p>我々は以下のフォーマットでコメントを追加するだけで良い</p>

<pre><code>//go:generate shell command
</code></pre>

<p>こうすることで実行時に<code>go generate</code>が<code>command</code>を自動で呼び出してくれる。</p>

<p>以下の2点を覚えておかねばならない。</p>

<ul>
<li><code>go generate</code>はプログラムまたはパッケージを書いている開発者によって実行されるべきだ。<code>go get</code>からは自動で呼ばれない。</li>
<li><code>go generate</code>に呼ばれる全てのツールは事前にシステム上にインストール及びセットアップする必要がある。どのツールを使うか、どこでダウンロードできるかは必ず記述すること。</li>
</ul>

<p>さらにコード生成ツールが同じレポジトリにある場合は<code>go:generate</code>から<code>go run</code>を呼び出すことを推奨する。そうすることでツール変更時にツールのビルドとインストールをせずに<code>generate</code>を実行することができる。</p>

<h2 id="どのようにツールを作り始めるか:e2f2be23ee9108c94286c14975225274">どのようにツールを作り始めるか</h2>

<p>stdlibパッケージによるコードのパースと生成は素晴らしいが、ドキュメントが膨大であるし、ドキュメントからどのようにパッケージを使うかを理解するのはかなり難しいだろう。</p>

<p>私がコード生成を始めた際に行って最も良かったことは既存のツールを学ぶということだ。
これは以下の3つの目的がある。</p>

<ol>
<li>どのようなツールが作れるかインスピレーションが得られる</li>
<li>ツールのソースコードから学ぶチャンスがある</li>
<li>ツール自身がいかに便利かを知ることができる</li>
</ol>

<h2 id="学びが得られるプロジェクト:e2f2be23ee9108c94286c14975225274">学びが得られるプロジェクト</h2>

<h3 id="インターフェースを実装するスタブの生成:e2f2be23ee9108c94286c14975225274">インターフェースを実装するスタブの生成</h3>

<p>実装するインターフェースに定義されているメソッドの一覧をコピペしたことはないだろうか。</p>

<p><a href="https://github.com/josharian/impl"><code>impl</code></a>コマンドを使うとスタブを自動生成することができる。
これはstdlibのパッケージを使ってインターフェースを探し、実装するべきメソッドを出力してくれる。</p>

<pre><code class="language-go">$ impl 'f *File' io.ReadWriteCloser
func (f *File) Read(p []byte) (n int, err error) {
    panic(&quot;not implemented&quot;)
}

func (f *File) Write(p []byte) (n int, err error) {
    panic(&quot;not implemented&quot;)
}

func (f *File) Close() error {
    panic(&quot;not implemented&quot;)
}
</code></pre>

<h3 id="mockeryを使ったモックの自動生成:e2f2be23ee9108c94286c14975225274">mockeryを使ったモックの自動生成</h3>

<p><a href="https://github.com/stretchr/testify">testify</a>の<a href="https://godoc.org/github.com/stretchr/testify/mock">mock</a>パッケージは単体テスト時にdependencyのモックを作成を容易にしてくれる。
インターフェースは暗黙的に満たされるものなので、dependencyはインターフェースを使って指定し、単体テスト時に外部のdependencyではなくモックを使うことができる。</p>

<p>例として小文字変換インターフェースのモックを作ると以下のようになる。</p>

<pre><code class="language-go">package main

import (
  &quot;testing&quot;

  &quot;github.com/stretchr/testify/mock&quot;
)

type downcaser interface {
  Downcase(string) (string, error)
}

func TestMock(t *testing.T) {
  m := &amp;mockDowncaser{}
  m.On(&quot;Downcase&quot;, &quot;FOO&quot;).Return(&quot;foo&quot;, nil)
  m.Downcase(&quot;FOO&quot;)
  m.AssertNumberOfCalls(t, &quot;Downcase&quot;, 1)
}
</code></pre>

<p>モックの実装は以下のようになる。</p>

<pre><code class="language-go">type mockDowncaser struct {
  mock.Mock
}

func (m *mockDowncaser) Downcase(a0 string) (string, error) {
  ret := m.Called(a0)
  return ret.Get(0).(string), ret.Error(1)
}
</code></pre>

<p>実装から分かるように、インターフェースの定義そのものがモックの自動生成に必要な全ての情報を持っている。</p>

<p><a href="https://github.com/vektra/mockery"><code>mockery</code></a>を使うと自動生成ができる。</p>

<pre><code>$ mockery -inpkg -testonly -name=downcaser
Generating mock for: downcaser
</code></pre>

<p>私は常に<code>go generate</code>を使ってインターフェースのモックを生成している。
先述のコードに1行追加するだけで良い。</p>

<pre><code class="language-go">package main

import (
  &quot;testing&quot;
)

type downcaser interface {
  Downcase(string) (string, error)
}

//go:generate mockery -inpkg -testonly -name=downcaser

func TestMock(t *testing.T) {
  m := &amp;mockDowncaser{}
  m.On(&quot;Downcase&quot;, &quot;FOO&quot;).Return(&quot;foo&quot;, nil)
  m.Downcase(&quot;FOO&quot;)
  m.AssertNumberOfCalls(t, &quot;Downcase&quot;, 1)
}
</code></pre>

<p>以下のように<code>go generate</code>を実行すると全てがセットアップされる。</p>

<pre><code class="language-go">$ go test
# github.com/ernesto-jimenez/test
./main_test.go:14: undefined: mockDowncaser
FAIL    github.com/ernesto-jimenez/test [build failed]

$ go generate
Generating mock for: downcaser

$ go test
PASS
ok      github.com/ernesto-jimenez/test 0.011s
</code></pre>

<p>インターフェースに変更を加えた際は<code>go generate</code>を実行するだけで関連するモックが最新化される。</p>

<p><code>mockery</code>は私が<code>testify/mock</code>にコントリビュートして<code>testify</code>のメンテナになった主な理由である。
しかしこれは1.5で<code>go/types</code>が標準ライブラリの一部となる前に作られたものであるので、低レベルな<code>go/ast</code>を使って実装されている。
そのためコードを追いにくくなっているし、<a href="https://github.com/vektra/mockery/issues/18">コンポジションを使ったインターフェースでモック生成に失敗する</a>等のバグを導入してしまっている。</p>

<h3 id="gogenの実験:e2f2be23ee9108c94286c14975225274">gogenの実験</h3>

<p>コード生成についての知識を深めるために作っていた<a href="https://github.com/ernesto-jimenez/gogen"><code>gogen</code></a>パッケージに含まれるコード生成ツールをオープンソースにした。</p>

<p>現時点では以下の3つのツールを含んでいる。</p>

<ul>
<li><a href="https://github.com/ernesto-jimenez/gogen/tree/master/cmd/goautomock/main.go">goautomock</a>: mockeryの類似ツールだが<code>go/ast</code>ではなく<code>go/types</code>を使って実装しているので、コンポジションを使ったインターフェースにも対応している。標準ライブラリのインターフェースをモックするのも簡単になっている。</li>
<li><a href="https://github.com/ernesto-jimenez/gogen/tree/master/cmd/gounmarshalmap">gounmarshalmap</a>: structを受け取り、mapをstructにデコードする<code>UnmarshalMap(map[string]interface{})</code>関数を生成する。
これは<a href="https://github.com/mitchellh/mapstructure"><code>mapstructure</code></a>の代替となるものでリフレクションではなくコード生成を使っている。</li>
<li><a href="https://github.com/ernesto-jimenez/gogen/tree/master/cmd/gospecific">gospecific</a>: <code>interface{}</code>を使った汎用のパッケージから特定のパッケージを生成する。汎用のパッケージのソースコードを読み、汎用のパッケージが<code>interface{}</code>を使っている箇所に対して特定の型を使ったパッケージを生成する(訳注:分かりにくいと思うのでリンク先の例を見てもらった方が良いかと思います。)。</li>
</ul>

<h2 id="まとめ:e2f2be23ee9108c94286c14975225274">まとめ</h2>

<p>コード生成は素晴らしい。同じコードを繰り返し何度も書かずに型安全を保つことができる。<a href="https://slackline.io/">Slackline</a>ではよく使ったし、<a href="https://github.com/stretchr/testify/pull/241">testify</a>でも恐らく使うだろう。</p>

<p>しかし「ツールを書くことが時間的に見合っているか？」ということは考えなければならない。</p>

<p>この答えには<a href="https://xkcd.com/1205/">xkcd</a>が役に立つだろう。</p>

<p><a href="https://xkcd.com/1205://xkcd.com/1205/"><img src="http://imgs.xkcd.com/comics/is_it_worth_the_time.png" alt="" class="pure-img" ></a></p>

      </div>
      
      <div class="share">
        <h4>Share</h4>
        
        <a href="#" data-type="twitter" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/10-reducing-boilerplate-with-go-generate-ja/" data-description="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法" data-via="daikikohara" class="prettySocial fa fa-twitter"></a>
        
        <a href="#" data-type="facebook" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/10-reducing-boilerplate-with-go-generate-ja/" data-title="12月10日 - Reducing boilerplate with go generate" data-description="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法" data-media="" class="prettySocial fa fa-facebook"></a>
        <a href="#" data-type="googleplus" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/10-reducing-boilerplate-with-go-generate-ja/" data-description="2015年12月10日のGopherAcademyのAdvent Calendarの日本語訳。go generateを使ってboilerpdateコードの手動での記述を削減する方法" class="prettySocial fa fa-google-plus"></a>
        <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/gopheracademy-advent-2015-ja/10-reducing-boilerplate-with-go-generate-ja/" class="hatena-bookmark-button fa fa-hatena" data-hatena-bookmark-title="12月10日 - Reducing boilerplate with go generate" data-hatena-bookmark-layout="simple" title="このエントリーをはてなブックマークに追加"></a>
      </div>
      
      
    </section>
  </div>
  <footer class="footer-single pure-g">
  <hr>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-left">
    <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="http://localhost:1313/images/cc.png" />
    </a>
    Except where otherwise noted, content on this site is licensed under a <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
  </div>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-right">
    &#169; 2015 Daiki Kohara<br>
    Powered by <a href="https://gohugo.io/" target="_blank">hugo</a>
  </div>
</footer>
<script src="http://localhost:1313//js/all.min.js"></script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<script>hljs.initHighlightingOnLoad();</script>

</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>12月3日 - Debugging Go programs with Delve  &middot; tbd</title>
  <meta name="description" content="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ">
  <meta name="format-detection" content="telephone=no">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="daikikohara" />
  <meta name="twitter:title" content="12月3日 - Debugging Go programs with Delve  &middot; tbd">
  <meta name="twitter:description" content="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ">

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="12月3日 - Debugging Go programs with Delve  &middot; tbd">
  <meta property="og:description" content="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ">

  <link rel="icon" href="http://localhost:1313/favicon.ico" >
  <link rel="shortcut icon" href="http://localhost:1313/favicon.ico" >
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:1313//css/pure-min.css">
  
  
    <link rel="stylesheet" href="http://localhost:1313//css/grids-responsive-min.css">
  
  <link rel="stylesheet" href="http://localhost:1313//css/all.min.css">
</head>
<body>


<div id="container">
  <header class="header">
  <div class="header-content pure-g">
    <div class="header-content-left pure-u-1 pure-u-md-1-2">
      <a class="site-title" href="http://localhost:1313/">tbd</a>
      <span class="site-description"></span>
    </div>
    <div class="header-content-right pure-u-1 pure-u-md-1-2">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="http://localhost:1313/about">About</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/blog">Blog</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/work">Work</a>
        </li>
      </ul>
    </div>
  </div>
</header>

  <div class="main">
    <div class="meta">
      <time class="time">31 Dec 2015, 15:09</time>
      <span class="category">
        
          categories:
          
          <a class="category-name category-name-golang" href="http://localhost:1313//categories/golang">golang</a>
        
      </span>
    </div>
    <section class="post">
      <header>
        <div class="title-single">12月3日 - Debugging Go programs with Delve </div>
        <div class="author">
          
          
            元記事の著者 - <strong class="author-name">Derek Parker</strong>
          
        </div>
      </header>
      <div class="description">
        

<div class='note'>※本ポストは<a href="https://blog.gopheracademy.com/">Gopher Academy</a>の<a href="https://blog.gopheracademy.com/series/advent-2015/">Advent 2015</a>の<a href="https://blog.gopheracademy.com/advent-2015/debugging-with-delve/">12月3日の記事</a>の日本語訳です。</div>

<p>バグトラッキングはイライラする作業である。並列処理のコードでは特にそうだろう。難しかったり再現させにくいバグをトラッキングする際は、優れたデバッガを自在に使えたら状況が一変するだろう。
このポストではGoのデバッガである<a href="https://github.com/derekparker/delve">Delve</a>について説明しよう。</p>

<p>Delveは<a href="https://www.gnu.org/software/gdb/">GDB</a>等の従来のツールを使ってGoのデバッグをしている時に開発者が感じる様々な問題を解決することを目的としている。
なぜ既存のツールが十分でないのかは<a href="https://golang.org/doc/gdb">gdbのドキュメント</a>のIntroductionの段落を見て頂くか、ツールの技術的な詳細を語った私の<a href="https://www.youtube.com/watch?v=InG72scKPd4">Gophercon2015の発表</a>を見て頂くとよく分かるだろう。</p>

<p>以下ではDelveをもう少し詳しく見ていき、使用例を紹介しよう。</p>

<h2 id="セットアップ:a1b4b0400b669ac17eb59f631a77958a">セットアップ</h2>

<p>DelveはLinuxとOSX上でのみサポートされているがWindowsも<a href="https://github.com/derekparker/delve/pull/276">まもなくサポートされる。</a></p>

<p>まだDelveをインストールしていなければ<a href="https://github.com/derekparker/delve/wiki/Building">インストール方法</a>を確認して使い始めて見て欲しい。
OSXを使っている場合は手順に従ってバイナリにコード署名する必要がある。インストールが完了したらGoのプログラムをデバッグする準備は完了である。</p>

<h2 id="プログラムのデバッグ:a1b4b0400b669ac17eb59f631a77958a">プログラムのデバッグ</h2>

<p>正直になろう。デバッガを使おうとしているということは既に物事が思い通り行っていないということだ。
プログラムが動かなくてなぜだか分からない状態だ。
この状態ではツールが邪魔になるべきではない。
使いやすさが一番だが、これをデバッグセッションをどう始めるか説明することでデモできる。</p>

<h3 id="ビルドとデバッグ:a1b4b0400b669ac17eb59f631a77958a">ビルドとデバッグ</h3>

<pre><code class="language-go:">$ dlv debug
</code></pre>

<p><code>go build</code>を実行するディレクトリと同じディレクトリで上記のコマンドを実行すると、プログラムをコンパイルし、デバッグ用のflag付きでバイナリを生成し、プログラムを起動、デバッガのアタッチ、プログラムを調査するためのプロンプトが立ち上がる。</p>

<h3 id="テスト用バイナリのビルドとデバッグ:a1b4b0400b669ac17eb59f631a77958a">テスト用バイナリのビルドとデバッグ</h3>

<pre><code class="language-go">$ dlv test
</code></pre>

<p><code>main</code>関数が無い、またはテストコードの実行環境でプログラムをデバッグしたい場合、上記のコマンドを使う。これも先ほどの例と同様にテストのバイナリをビルドし、デバッグ用にflagを付与し、デバッグ用のプロンプトが立ち上がる。</p>

<h3 id="実行中のプロセスへのアタッチ:a1b4b0400b669ac17eb59f631a77958a">実行中のプロセスへのアタッチ</h3>

<pre><code class="language-go">$ dlv attach &lt;pid&gt;
</code></pre>

<p>実行中のプロセスにアタッチしてデバッグを開始する。このコマンドは即座にプロセスを停止してデバッグのセッションを開始する。ただし特定の最適化がされたバイナリに対してデバッグしようとすると問題が起こる可能性がある。</p>

<h3 id="デバッグではなくトレース:a1b4b0400b669ac17eb59f631a77958a">デバッグではなくトレース</h3>

<pre><code class="language-go">$ dlv trace [regexp]
</code></pre>

<p><code>[regexp]</code>にマッチする関数にトレースポイントをセットしプログラムをコンパイル、開始する。
これはフルデバッグセッションを開始しないがトレースポイントに達した際に情報を出力する。</p>

<h3 id="その他のコマンド:a1b4b0400b669ac17eb59f631a77958a">その他のコマンド</h3>

<p>ここまで紹介したものが最もよく使うコマンドになるだろうが、他にも以下のようなコマンドがある。</p>

<ul>
<li><code>dlv exec ./path/to/binary</code> - 既存のバイナリの実行とアタッチ</li>
<li><code>dlv connect</code> - headlessデバッグサーバに接続</li>
</ul>

<h2 id="さぁやってみよう:a1b4b0400b669ac17eb59f631a77958a">さぁやってみよう</h2>

<p><code>(dlv)</code>というプロンプトが表示され、プログラムの調査を始める準備が整った。</p>

<p>以下のような小さいプログラムを考えてみよう。</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;sync&quot;
)

func dostuff(wg *sync.WaitGroup, i int) {
	fmt.Printf(&quot;goroutine id %d\n&quot;, i)
	fmt.Printf(&quot;goroutine id %d\n&quot;, i)
	wg.Done()
}

func main() {
	var wg sync.WaitGroup
	workers := 10

	wg.Add(workers)
	for i := 0; i &lt; workers; i++ {
		go dostuff(&amp;wg, i)
	}
	wg.Wait()
}
</code></pre>

<p><code>dlv debug</code>を入力してデバッグセッションを開始し、以下のように<code>main</code>にブレークポイントを設定しよう</p>

<pre><code class="language-go">(dlv) break main.main
Breakpoint 1 set at 0x22c7 for main.main ./test.go:15
</code></pre>

<p>出力結果はブレークポイントのIDとブレークポイントがセットされたアドレス、関数名、ファイル名:行番号となっている。</p>

<p><code>continue</code>コマンドを使うとブレークポイントの位置まで続行できる。ブレークポイントで停止したら、<code>next</code>と入力してエンターキーを押すことでプログラムを調査できる(delveは空行を入力されると最後に実行したコマンドを繰り返す)。<code>next</code>コマンドはソースコードを1行ずつ進めていく。<code>print</code>コマンドを使って<code>workers</code>の値を見てみよう。</p>

<pre><code class="language-go">(dlv) print workers
10
</code></pre>

<p>delveは以下のような式の評価もできる。</p>

<pre><code class="language-go">(dlv) print workers &lt; 100
true
</code></pre>

<p><code>dostuff</code>関数にもブレークポイントをセットしてみよう。</p>

<pre><code class="language-go">(dlv) break dostuff
Breakpoint 2 set at 0x205f for main.dostuff ./test.go:9
</code></pre>

<p>再度<code>continue</code>を使ってブレークポイントまで行ってみよう</p>

<pre><code class="language-go">(dlv) continue
&gt; main.dostuff() ./test.go:9 (hits goroutine(6):1 total:1)

     4:         &quot;fmt&quot;
     5:         &quot;sync&quot;
     6: )
     7:
     8: func dostuff(wg *sync.WaitGroup, i int) {
=&gt;   9:         fmt.Printf(&quot;goroutine id %d\n&quot;, i)
    10:         fmt.Printf(&quot;goroutine id %d\n&quot;, i)
    11:         wg.Done()
    12: }
    13:
    14: func main() {
</code></pre>

<p><code>(dlv) print i</code>を使って<code>i</code>の値を出力してみよう。そして<code>next</code>コマンドを使って<code>i</code>の値を再度出力してみよう。同じものであり、それが偶然ではないことが分かるだろう。</p>

<p>この関数を実行する10個のgoroutineを作ったが同じgoroutineに辿り着く。これはDelveがGo専用のデバッガでGoroutineのようなGo特有の実行環境を理解しているからである。
<code>next</code>コマンドを実行するとDelveは同じGoroutineの次のソース行に辿り着くことを保証する。これは他のツールで<code>next</code>と同等のコマンドを実行した時に別のgoroutineに辿り着いてしまう、イライラする&rsquo;thrashing&rsquo;(訳注:他のGoroutineと行ったり来たりしてしまう現象だと思われる)から解放してくれる。</p>

<h2 id="まとめ:a1b4b0400b669ac17eb59f631a77958a">まとめ</h2>

<p>この記事で紹介したのはDelveができることの基礎の基礎だけで、表面的に触ってみただけに過ぎない。
お使いのプログラムにDelveを適用してみて<code>help</code>コマンドでプログラムの調査に使える全ての方法をチェックしてみて欲しい。</p>

<p>Delveはまだpre1.0なので既存機能の改善及び新機能の追加を予定していることは覚えておいて欲しい。</p>

<h2 id="how-to-contribute:a1b4b0400b669ac17eb59f631a77958a">How to contribute</h2>

<p>このプロジェクトはオープンソースなので良かったらチェックアウトしてみて欲しい。バージョン1.0のリリースはまもなくの予定だ。得られるフィードバックとコントリビューションを全て活用したい。
<a href="https://github.com/derekparker/delve">レポジトリ</a>をチェックアウトして遠慮無くissueを上げたりパッチを送ったりして欲しい。</p>

<p>もしDelveをHackしてみたいけど何から初めて良いか分からないならコントリビューションの助けとなる助言や資料に関して質問して欲しい。</p>

      </div>
      
      <div class="share">
        <h4>Share</h4>
        
        <a href="#" data-type="twitter" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/3-debugging-with-delve-ja/" data-description="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ" data-via="daikikohara" class="prettySocial fa fa-twitter"></a>
        
        <a href="#" data-type="facebook" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/3-debugging-with-delve-ja/" data-title="12月3日 - Debugging Go programs with Delve " data-description="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ" data-media="" class="prettySocial fa fa-facebook"></a>
        <a href="#" data-type="googleplus" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/3-debugging-with-delve-ja/" data-description="2015年12月3日のGopherAcademyのAdvent Calendarの日本語訳。delveを使ったデバッグ" class="prettySocial fa fa-google-plus"></a>
        <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/gopheracademy-advent-2015-ja/3-debugging-with-delve-ja/" class="hatena-bookmark-button fa fa-hatena" data-hatena-bookmark-title="12月3日 - Debugging Go programs with Delve " data-hatena-bookmark-layout="simple" title="このエントリーをはてなブックマークに追加"></a>
      </div>
      
      
    </section>
  </div>
  <footer class="footer-single pure-g">
  <hr>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-left">
    <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="http://localhost:1313/images/cc.png" />
    </a>
    Except where otherwise noted, content on this site is licensed under a <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
  </div>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-right">
    &#169; 2015 Daiki Kohara<br>
    Powered by <a href="https://gohugo.io/" target="_blank">hugo</a>
  </div>
</footer>
<script src="http://localhost:1313//js/all.min.js"></script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<script>hljs.initHighlightingOnLoad();</script>

</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

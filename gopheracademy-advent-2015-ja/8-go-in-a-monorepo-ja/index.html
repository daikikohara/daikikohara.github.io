<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>12月8日 - Go in a Monorepo &middot; tbd</title>
  <meta name="description" content="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話">
  <meta name="format-detection" content="telephone=no">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="daikikohara" />
  <meta name="twitter:title" content="12月8日 - Go in a Monorepo &middot; tbd">
  <meta name="twitter:description" content="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話">

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="12月8日 - Go in a Monorepo &middot; tbd">
  <meta property="og:description" content="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話">

  <link rel="icon" href="http://localhost:1313/favicon.ico" >
  <link rel="shortcut icon" href="http://localhost:1313/favicon.ico" >
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://localhost:1313//css/pure-min.css">
  
  
    <link rel="stylesheet" href="http://localhost:1313//css/grids-responsive-min.css">
  
  <link rel="stylesheet" href="http://localhost:1313//css/all.min.css">
</head>
<body>


<div id="container">
  <header class="header">
  <div class="header-content pure-g">
    <div class="header-content-left pure-u-1 pure-u-md-1-2">
      <a class="site-title" href="http://localhost:1313/">tbd</a>
      <span class="site-description"></span>
    </div>
    <div class="header-content-right pure-u-1 pure-u-md-1-2">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="http://localhost:1313/about">About</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/blog">Blog</a>
        </li>
        <li class="nav-item">
          <a href="http://localhost:1313/work">Work</a>
        </li>
      </ul>
    </div>
  </div>
</header>

  <div class="main">
    <div class="meta">
      <time class="time">31 Dec 2015, 15:09</time>
      <span class="category">
        
          categories:
          
          <a class="category-name category-name-golang" href="http://localhost:1313//categories/golang">golang</a>
        
      </span>
    </div>
    <section class="post">
      <header>
        <div class="title-single">12月8日 - Go in a Monorepo</div>
        <div class="author">
          
          
            元記事の著者 - <strong class="author-name">Matt Layher</strong>
          
        </div>
      </header>
      <div class="description">
        

<div class='note'>※本ポストは<a href="https://blog.gopheracademy.com/">Gopher Academy</a>の<a href="https://blog.gopheracademy.com/series/advent-2015/">Advent 2015</a>の<a href="https://blog.gopheracademy.com/advent-2015/go-in-a-monorepo/">12月8日の記事</a>の日本語訳です。</div>

<p>&ldquo;monorepo&rdquo;とは多くの異なるプロジェクトやライブラリを含むモノリシックなコードレポジトリである。DigitalOceanでは全てのGoのコード用に<code>cthulhu</code>というmonorepoを作成した。<code>cthulhu</code>は我々の内製のGoライブラリ、サービス、ツール及びサードパーティのdependency用の総合的なレポジトリを提供するという目的がある。</p>

<p><a href="https://twitter.com/bryanl">Bryan Liles</a>が<code>cthulhu</code>の<a href="https://www.digitalocean.com/company/blog/taming-your-go-dependencies/">ブログポスト</a>を2015年初めに書いている。
本ポストでも同じトピックを多くカバーするが、<code>cthulhu</code>をより良くするためにこの一年行ってきた改善についても述べる。</p>

<h2 id="monorepo-structure:e04c8bdeb332a3a711713cc22d300943">Monorepo Structure</h2>

<p><code>cthulhu</code>は単一のモノリシックなgitレポジトリである。以下のようないくつかの重要なトップレベルのファイルとディレクトリを含んでいる。</p>

<pre><code>cthulhu
├── .drone.yml
├── analyze.sh
├── docode/
│   └── src/
└── third_party/
    └── src/
</code></pre>

<ul>
<li><code>.drone.yml</code>: <a href="https://drone.io/">drone</a>を使ったCIビルド用の設定

<ul>
<li>自動化されたlintチェックの実行、Goテスト、及びバイナリのビルドと社内のアーティファクトサーバへのアップロードを行う</li>
</ul></li>
<li><code>analyze.sh</code>: Goのエコシステムで利用可能な素晴らしいツール群を使ったコード解析をCIで行うスクリプト

<ul>
<li><code>goimports</code>, <code>go vet</code>, <code>golint</code>。内製のlintツールもまもなく導入する。</li>
</ul></li>
<li><code>docode/</code>: <code>$GOPATH</code>の一部となるもので内製のライブラリ、サービスおよびツールが含まれる。</li>
<li><code>third_party/</code>: <code>$GOPATH</code>の一部となるものでサードパーティのdependencyが含まれる。</li>
</ul>

<p>$GOPATHに<code>{CTHULHU}/third_party:{CTHULHU}/docode</code>を設定することでサードパーティのdependencyを<code>go get</code>し、内製コードのビルドとテストができる。</p>

<h2 id="内製コード:e04c8bdeb332a3a711713cc22d300943">内製コード</h2>

<p>全ての内製コードは<code>${CTHULHU}/docode/</code>に格納されている。このディレクトリ内は異なる目的の4つのディレクトリに分かれている。</p>

<pre><code>docode/
└── src/
    ├── doge/
    ├── exp/
    ├── services/
    └── tools/
</code></pre>

<ul>
<li><code>doge/</code>: <strong>D</strong>igital<strong>O</strong>cean <strong>G</strong>o <strong>E</strong>nvironment: 内製の標準ライブラリ

<ul>
<li>多くの内製プロジェクトで使われる様々なパッケージ</li>
<li>構造化されたkey/valueのロギング</li>
<li>APIのアウトプットに応じてリクエストのリトライが可能なHTTPクライアント</li>
<li>データベースとの最低限のやり取りを行うレイヤ</li>
<li>サービスの状態とメトリクス</li>
</ul></li>
<li><code>exp/</code>: 新規に追加されたもの(訳注:前回のブログポストからの追加分という意味だと思われる):実験的なコードのホーム

<ul>
<li>サービスまたはツールがプロダクション環境にデプロイする前の試験場として使われる</li>
<li>実験的なコードをまとめてデプロイしないように、CIプロセスの中で作られないアーティファクト</li>
<li>masterのrebaseを行い続けるfeatureブランチの苦痛を和らげるために使われる</li>
</ul></li>
<li><code>services/</code>: DigitalOceanクラウドの重い処理を実行する長期間実行するサービス

<ul>
<li>典型的にはHTTP APIサーバとクライアント</li>
<li>現在開発中のgRPCサービス</li>
</ul></li>
<li><code>tools/</code>: 有益なアクションを実行する短時間実行されるユーティリティ

<ul>
<li><code>goimports</code>のfork</li>
<li>内製のlintツール</li>
</ul></li>
</ul>

<h2 id="サードパーティコード:e04c8bdeb332a3a711713cc22d300943">サードパーティコード</h2>

<p>サードパーティのdependencyは<code>${CTHULHU}/third_party/</code>に格納される。このディレクトリは<code>$GOPATH</code>の中で<code>${CTHULHU}/docode/</code>の前なのでdependencyを<code>go get</code>するだけでレポジトリに追加できる。</p>

<p>git submoduleを使わなければいけなくなる問題を避けるために、レポジトリにコミットする前に<code>.git</code>ディレクトリを<code>.checkout_git</code>にリネームしている。
ベンダリングしたdependencyをアップデートしたい場合は再度ディレクトリを<code>.git</code>にリネームして最新の変更をpullする。おそらくより良いアプローチがあるだろうが、滅多にサードバーティのdepenencyのバージョンを変えたりはしないので、今のところ上手く行っている。</p>

<h2 id="monorepoの利点:e04c8bdeb332a3a711713cc22d300943">Monorepoの利点</h2>

<p><code>cthulhu</code>のアイデアが<a href="https://twitter.com/AntoineGrondin">Antoine Grondin</a>によって提案された当初は懐疑的だった。しかしmonorepoを数週間使ってみると、Goの開発者のチームでは最も良い方法だと確信した。</p>

<p>Goのエコシステムの素晴らしいツールの数々はmonorepoで使われるとより良いものになる。例えば<code>gorename</code>は信じられないくらい便利だ。
つい最近全てのレポジトリ内のソースファイル内で<code>foo.FooDB</code>から<code>foo.DB</code>にリネームすることができた。このようにまとめてリファクタリングできるというのは大変素晴らしいものである。
あらゆる変更は全ての内製のGoプロジェクトに渡ってコンパイル・テストされる。</p>

<p>最近、CIビルド中に<code>analyze.sh</code>を使って様々な自動lintチェックを実行する実験を始めた。
全てのコードが<code>cthulhu</code>内にあるので<code>gofmt</code>や<code>go vet</code>等を満たさないようなコードが入るとビルドを失敗させることができる。
さらに、標準ライブラリの<code>go/ast</code>という素晴らしいパッケージを使った内製のlintツールに取り組んでいる。
その内の一つは<code>explint</code>と呼ばれているが、これは実験的な<code>exp/</code>ディレクトリ内のコードがプロダクション用の<code>services/</code>や<code>tools/</code>内の他のコードからimportされていないことを保証するものである。</p>

<p>最後に、monorepoはサードバーティのdependencyをベンダリングする際の問題を解決してくれる。
<code>cthulhu</code>の全てのプロジェクトは同じバージョンのサードバーティライブラリを使用する。そしてライブラリのバージョンが上がった場合は、それを利用する全てのプロジェクトが自動的にビルド及びテストされる。
最近、<code>$GO15VENDOREXPERIMENT=1</code>を試してみたが、残念ながら<code>goimports</code>で問題があり、元に戻さなければならなかった。<code>goimports</code>が<a href="https://github.com/golang/go/issues/12278">アップデートされたら</a>再度挑戦したい。</p>

<h2 id="monorepoの欠点:e04c8bdeb332a3a711713cc22d300943">Monorepoの欠点</h2>

<p>我々のケースではmonorepoを使う利点がコストを上回るが、常に良い方法ではない。</p>

<p><code>cthulhu</code>が成長するにつれ、CIテストの時間も増大する。
毎日プロジェクトやテストが追加されていてそれらの中にはデータベースのテストを必要とするものもある。
Russ Coxによる<a href="https://github.com/rsc/gt">gt</a>を試してはみたがまだ<code>cthulhu</code>に採用はされていない。</p>

<p>monorepoは多くのプロジェクトへのコミットが日々あるので、featureブランチがすぐに昔のものになってしまうことがある。
だから我々はfeatureブランチに実験的なコードを持つのではなく、<code>exp/</code>ディレクトリを採用した。
<code>exp/</code>は今のところ上手く行っているが<code>exp/</code>からプロダクション用の<code>services/</code>や<code>tools/</code>に移すときのガイドラインは検討中だ。</p>

<p>先述したとおり、サードバーティの<code>.git</code>ディレクトリはgit submoduleではなくリネームしている。これは理想的な方法とは言えないが、今のところサードバーティのコードに触れることは稀なので上手く行っている。</p>

<h2 id="サマリ:e04c8bdeb332a3a711713cc22d300943">サマリ</h2>

<p>DigitalOceanのmonorepoである<code>cthulhu</code>を使った開発体験は私にとって今までで最も心地よいものの1つになっている。
複数のレポジトリでdependencyを最新に保つ方法よりは遥かに上手くいっている。
実験的なプロダクションを壊す心配をせずに、Goのエコシステムの素晴らしいツールを使って大規模なリファクタリングを可能にしてくれる。</p>

<p>monorepoに関して質問や詳細が知りたかったら<a href="https://gophers.slack.com/">Gophers Slack</a>のmdlayherに聞いて欲しい。</p>

      </div>
      
      <div class="share">
        <h4>Share</h4>
        
        <a href="#" data-type="twitter" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/8-go-in-a-monorepo-ja/" data-description="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話" data-via="daikikohara" class="prettySocial fa fa-twitter"></a>
        
        <a href="#" data-type="facebook" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/8-go-in-a-monorepo-ja/" data-title="12月8日 - Go in a Monorepo" data-description="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話" data-media="" class="prettySocial fa fa-facebook"></a>
        <a href="#" data-type="googleplus" data-url="http://localhost:1313/gopheracademy-advent-2015-ja/8-go-in-a-monorepo-ja/" data-description="2015年12月8日のGopherAcademyのAdvent Calendarの日本語訳。DigitalOceanの単一のレポジトリで全てのGoコードを管理するmonorepoの話" class="prettySocial fa fa-google-plus"></a>
        <a href="http://b.hatena.ne.jp/entry/http://localhost:1313/gopheracademy-advent-2015-ja/8-go-in-a-monorepo-ja/" class="hatena-bookmark-button fa fa-hatena" data-hatena-bookmark-title="12月8日 - Go in a Monorepo" data-hatena-bookmark-layout="simple" title="このエントリーをはてなブックマークに追加"></a>
      </div>
      
      
    </section>
  </div>
  <footer class="footer-single pure-g">
  <hr>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-left">
    <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="http://localhost:1313/images/cc.png" />
    </a>
    Except where otherwise noted, content on this site is licensed under a <a rel="license" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
  </div>
  <div class="pure-u-1 pure-u-md-1-2 footer-single-right">
    &#169; 2015 Daiki Kohara<br>
    Powered by <a href="https://gohugo.io/" target="_blank">hugo</a>
  </div>
</footer>
<script src="http://localhost:1313//js/all.min.js"></script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<script>hljs.initHighlightingOnLoad();</script>

</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>


<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>
